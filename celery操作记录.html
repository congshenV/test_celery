<html>
<head>
  <title>Evernote Export</title>
  <basefont face="微软雅黑" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="Evernote Windows/305825 (zh-CN, DDL); Windows/6.1.7601 Service Pack 1 (Win64);"/>
  <style>
    body, td {
      font-family: 微软雅黑;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="398"/>

<div>
<span><div><span style="font-size: 19px;"><span style="background-color: rgb(255, 250, 165); font-size: 19px;-evernote-highlight:true;">纯celery实例操作：</span></span></div><div style="box-sizing: border-box; padding: 8px; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);"><div><span style="font-size: 12px;"><span style="background-color: rgb(251, 250, 248); font-size: 12px; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; color: rgb(51, 51, 51);">新建celery实例，python脚本，具体内容在官网有简单实例。通过下面指令启动worker。</span></span></div><div><span style="font-size: 12px;"><span style="background-color: rgb(251, 250, 248); font-size: 12px; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; color: rgb(51, 51, 51);">celery -A tasks worker --loglevel=info</span></span></div><div><span style="font-size: 12px;"><span style="background-color: rgb(251, 250, 248); font-size: 12px; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; color: rgb(51, 51, 51);">直接通过队列启动worker：</span></span></div><div><span style="font-size: 12px;"><span style="background-color: rgb(251, 250, 248); font-size: 12px; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; color: rgb(51, 51, 51);">celery worker -b redis://192.168.180.128:6379/6 -n worker_congshen</span></span></div><div><span style="font-size: 12px;"><span style="background-color: rgb(251, 250, 248); font-size: 12px; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; color: rgb(51, 51, 51);">redis格式：</span></span><span style="background-color: rgb(251, 250, 248);">redis://:password@hostname:port/db_number</span></div><div><span style="font-size: 12px;"><span style="background-color: rgb(251, 250, 248); font-size: 12px; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; color: rgb(51, 51, 51);">任务调用：python里</span></span></div><div><span style="font-size: 12px;"><span style="background-color: rgb(251, 250, 248); font-size: 12px; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; color: rgb(51, 51, 51);">from tasks import add</span></span></div><div><span style="font-size: 12px;"><span style="background-color: rgb(251, 250, 248); font-size: 12px; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; color: rgb(51, 51, 51);">add.delay(1，1)</span></span></div><div><span style="font-size: 12px;"><span style="background-color: rgb(251, 250, 248); font-size: 12px; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; color: rgb(51, 51, 51);">通过项目启动，整个项目将celery的模块分工更加清晰，不像上面的简单实例那样配置、任务都在一个脚本里。</span></span><a href="http://www.cnblogs.com/forward-wang/p/5970806.html" style="background-color: rgb(251, 250, 248);">http://www.cnblogs.com/forward-wang/p/5970806.html</a><span style="background-color: rgb(251, 250, 248);">  对项目结构介绍得比较清楚。通过下面指令将项目的worker启动起来。</span></div><div><span style="font-size: 12px;"><span style="background-color: rgb(251, 250, 248); font-size: 12px; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; color: rgb(51, 51, 51);">celery -A proj -worker -Q queue --loglevel=info  </span></span></div><div><span style="font-size: 12px;"><span style="background-color: rgb(251, 250, 248); font-size: 12px; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; color: rgb(51, 51, 51);">加-B表示启动定时运行（定时任务要在配置文件或者任务描述里面写清楚），</span></span><span style="font-size: 12px;"><span style="background-color: rgb(251, 250, 248); font-size: 12px; color: rgb(48, 48, 48);">不加-B时，需要启动beat：</span></span><span style="background-color: rgb(251, 250, 248);">celery beat，这种情况通常要致命你的schedule源是哪里。</span></div></div><div><span style="font-size: 19px;"><span style="background-color: rgb(255, 250, 165); font-size: 19px;-evernote-highlight:true;">******************************************</span></span></div><div><span style="font-size: 14px;"><span style="background-color: rgb(255, 250, 165);-evernote-highlight:true;"><span style="font-size: 19px; background-color: rgb(255, 250, 165);-evernote-highlight:true;">django项目</span></span>：</span></div><div><span style="background-color: rgb(255, 250, 165);-evernote-highlight:true;"><span style="font-size: 14px; background-color: rgb(255, 250, 165); font-weight: bold;-evernote-highlight:true;">项目创建</span></span></div><div style="box-sizing: border-box; padding: 8px; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);"><div><span style="font-size: 12px;"><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-size: 12px; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">部署django-celery：</span></span></div><div><span style="font-size: 12px;"><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-size: 12px; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><span style="background-color: rgb(255, 250, 165); color: rgb(51, 51, 51); font-size: 12px; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;-evernote-highlight:true;">pip install django-celery</span>   注意，这里部署之后，celery不是最新的，而是3.+，</span></span><span style="font-size: 12px;"><span style="background-color: rgb(251, 250, 248); font-size: 12px; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; color: rgb(51, 51, 51);">这样安装的celery是3.1.25的，这样不会出现celery与django的版本冲突</span></span></div><div><span style="font-size: 12px;"><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-size: 12px; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">创建项目：</span></span></div><div><span style="font-size: 12px;"><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-size: 12px; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><span style="background-color: rgb(255, 250, 165); color: rgb(51, 51, 51); font-size: 12px; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;-evernote-highlight:true;">django-admin.py startproject dba_task_service</span>     该命令会创建一个项目文件夹</span></span></div><div><span style="font-size: 12px;"><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-size: 12px; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">cd dba_task_service</span></span></div><div><span style="font-size: 12px;"><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-size: 12px; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">创建app：</span></span></div><div><span style="font-size: 12px;"><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-size: 12px; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><span style="background-color: rgb(255, 250, 165); color: rgb(51, 51, 51); font-size: 12px; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;-evernote-highlight:true;">django-admin.py startapp taskdemo</span>                    该命令会在当前目录创建一个taskdemo目录</span></span></div><div><span style="font-size: 12px;"><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-size: 12px; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">项目+app的文件结构</span></span></div><div><span style="font-size: 12px;"><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-size: 12px; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">dba_task_service/</span></span></div><div><span style="font-size: 12px;"><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-size: 12px; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">                |——manage.py</span></span></div><div><span style="font-size: 12px;"><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-size: 12px; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">                |——dba_task_service /</span></span></div><div><span style="font-size: 12px;"><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-size: 12px; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">                                   |——__init__.py</span></span></div><div><span style="font-size: 12px;"><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-size: 12px; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">                                   |——settings.py</span></span></div><div><span style="font-size: 12px;"><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-size: 12px; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">                                   |——urls.py</span></span></div><div><span style="font-size: 12px;"><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-size: 12px; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">                                   |——wsgi.py</span></span></div><div><span style="font-size: 12px;"><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-size: 12px; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">                |——taskdemo/</span></span></div><div><span style="font-size: 12px;"><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-size: 12px; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">                                   |——admin.py</span></span></div><div><span style="font-size: 12px;"><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-size: 12px; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">                                   |——apps.py</span></span></div><div><span style="font-size: 12px;"><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-size: 12px; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">                                   |——__init__.py</span></span></div><div><span style="font-size: 12px;"><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-size: 12px; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">                                   |——models.py</span></span></div><div><span style="font-size: 12px;"><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-size: 12px; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">                                   |——tests.py</span></span></div><div><span style="font-size: 12px;"><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-size: 12px; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">                                   |——views.py</span></span></div><div><span style="font-size: 12px;"><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-size: 12px; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">                                   |——migrations/</span></span></div><div><span style="font-size: 12px;"><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-size: 12px; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">                                                 |——__init__.py</span></span></div><div><br/></div><ul><li><span style="font-size: 12px;"><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-size: 12px; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-size: 12px; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-weight: bold;">修改settings.py</span>文件：</span></span><span style="font-size: 12px;"><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-size: 12px; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">添加broker、backend、schedule的设置，添加app，设置时区</span></span></li><li><span style="font-size: 12px;"><span style="background-color: rgb(251, 250, 248); font-weight: bold; color: rgb(51, 51, 51); font-size: 12px; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">修改__init__.py</span></span></li><li><span style="font-size: 12px;"><span style="background-color: rgb(251, 250, 248); font-weight: bold; color: rgb(51, 51, 51); font-size: 12px; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">新建celery.py</span></span></li><li><span style="font-size: 12px;"><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-size: 12px; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-size: 12px; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-weight: bold;">新建taskdemo下的tasks.py</span>，也就是创建任务</span></span></li></ul><div><span style="font-size: 12px;"><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-size: 12px; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">这些文件的修改创建在</span></span><a href="http://blog.csdn.net/ns2250225/article/details/63253284" style="background-color: rgb(251, 250, 248);">http://blog.csdn.net/ns2250225/article/details/63253284</a><span style="background-color: rgb(251, 250, 248);">这里描述清楚，我也会在提交在git上</span><a href="https://github.com/congshenV/dba_task_service" style="background-color: rgb(251, 250, 248);">https://github.com/congshenV/dba_task_service</a></div><div><span style="font-size: 12px;"><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-size: 12px; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">然后是创建数据表并创建超级用户</span></span></div><div><span style="font-size: 12px;"><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-size: 12px; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">python manage.py makemigrations</span></span></div><div><span style="font-size: 12px;"><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-size: 12px; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">python manage.py migrate</span></span></div><div><span style="font-size: 12px;"><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-size: 12px; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">python manage.py createsuperuser</span></span></div><div><br/></div><div><br/></div><div><span style="font-size: 12px;"><span style="background-color: rgb(251, 250, 248); font-size: 12px; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; color: rgb(51, 51, 51);">今天在另外一台机子布的时候，发现python版本不是2.7.12，就会运行出错。搞定之后就可以了。</span></span></div></div><div><span style="background-color: rgb(255, 250, 165);-evernote-highlight:true;"><span style="font-size: 14px; background-color: rgb(255, 250, 165); font-weight: bold;-evernote-highlight:true;">项目运行</span></span></div><div style="text-indent: 28px;"><div style="box-sizing: border-box; padding: 8px; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);"><div><span style="font-size: 12px;"><span style="background-color: rgb(251, 250, 248); font-size: 12px; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; color: rgb(51, 51, 51);">python manage.py runserver 0.0.0.0:8888     启动web服务</span></span></div><div><span style="font-size: 12px;"><span style="background-color: rgb(251, 250, 248); font-size: 12px; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; color: rgb(51, 51, 51);">python manage.py celery worker -l info      启动worker</span></span></div><div><span style="font-size: 12px;"><span style="background-color: rgb(251, 250, 248); font-size: 12px; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; color: rgb(51, 51, 51);">python manage.py celery beat                启动beat定时任务安排</span></span></div><div><span style="font-size: 12px;"><span style="background-color: rgb(251, 250, 248); font-size: 12px; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; color: rgb(51, 51, 51);">flower -port=5555 -A dba_task_service       启动结果监视器，原来是celery flower -A proj，需要安装flower组件</span></span></div><div><br/></div><div><span style="font-size: 12px;"><span style="background-color: rgb(251, 250, 248); font-size: 12px; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; color: rgb(51, 51, 51);">如果需要多个worker来执行任务，通过指定broker以及任务、队列来执行：</span></span></div><div><span style="font-size: 12px;"><span style="background-color: rgb(251, 250, 248); font-size: 12px; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; color: rgb(51, 51, 51);">celery worker -b redis://192.168.180.128:6379/5 -n worker_congshen</span></span></div><div><br/></div><div><span style="font-size: 12px;"><span style="background-color: rgb(251, 250, 248); font-size: 12px; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; color: rgb(51, 51, 51);">遇到root的问题,执行:</span></span><span style="background-color: rgb(251, 250, 248);">export C_FORCE_ROOT=True   </span></div><div><span style="font-size: 12px;"><span style="background-color: rgb(251, 250, 248); font-size: 12px; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; color: rgb(51, 51, 51);">对于任务部署更详细的设计，稍后再进行。</span></span></div><div><span style="font-size: 12px;"><span style="background-color: rgb(251, 250, 248); font-size: 12px; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; color: rgb(51, 51, 51);">踏坑：</span></span></div><div><span style="font-size: 12px;"><span style="background-color: rgb(251, 250, 248); font-size: 12px; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; color: rgb(51, 51, 51);">1、settings.py allow_host添加'192.168.180.128'</span></span></div><div><span style="font-size: 12px;"><span style="background-color: rgb(251, 250, 248); font-size: 12px; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; color: rgb(51, 51, 51);">2、setting的app那些东西必须加上，要不然前端界面的模块加载不进去。</span></span></div><div><span style="font-size: 12px;"><span style="background-color: rgb(251, 250, 248); font-size: 12px; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; color: rgb(51, 51, 51);">3、CELERYBEAT_SCHEDULER = 'djcelery.schedulers.DatabaseScheduler'必须设置，忘了的话网页的定时任务是无法同步过来的。</span></span></div></div><div><span style="font-size: 19px;"><span style="background-color: rgb(255, 250, 165); font-size: 19px;-evernote-highlight:true;">********************************************************************************************************************</span></span></div><div><span style="font-size: 19px;"><span style="background-color: rgb(255, 250, 165); font-size: 19px;-evernote-highlight:true;">使用paramiko远程操作实例及结果</span></span></div><div style="box-sizing: border-box; padding: 8px; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);"><div><span style="font-size: 12px;"><span style="background-color: rgb(251, 250, 248); font-size: 12px; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; color: rgb(227, 0, 0); font-weight: bold;">&gt;&gt;&gt;ssh = paramiko.SSHClient()                   </span></span></div><div><span style="font-size: 12px;"><span style="background-color: rgb(251, 250, 248); font-size: 12px; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-weight: bold;">#表示hostknown没有也可以</span></span></div><div><span style="font-size: 12px;"><span style="background-color: rgb(251, 250, 248); font-size: 12px; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; color: rgb(227, 0, 0); font-weight: bold;">&gt;&gt;&gt;ssh.set_missing_host_key_policy(paramiko.AutoAddPolicy())</span></span></div><div><span style="font-size: 12px;"><span style="background-color: rgb(251, 250, 248); font-size: 12px; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; color: rgb(227, 0, 0); font-weight: bold;">&gt;&gt;&gt;ssh.connect(&quot;192.168.180.130&quot;,22,&quot;root&quot;,&quot;congshenv5&quot;)</span></span></div><div><span style="font-size: 12px;"><span style="background-color: rgb(251, 250, 248); font-size: 12px; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; color: rgb(227, 0, 0); font-weight: bold;">&gt;&gt;&gt;ssh.exec_command(&quot;pwd&quot;)</span></span></div><div><span style="font-size: 12px;"><span style="background-color: rgb(251, 250, 248); font-size: 12px; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; color: rgb(227, 0, 0); font-weight: bold;">&gt;&gt;&gt;stdin,stdout,stderr = ssh.exec_command(&quot;ping&quot;)</span></span></div><div><span style="font-size: 12px;"><span style="background-color: rgb(251, 250, 248); font-size: 12px; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; color: rgb(227, 0, 0); font-weight: bold;">&gt;&gt;&gt;stdout.read()</span></span></div><div><span style="font-size: 12px;"><span style="background-color: rgb(251, 250, 248); font-size: 12px; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">#执行结果需要</span></span> <span style="background-color: rgb(251, 250, 248);">bytes.decode(b)  解码</span></div><div><span style="font-size: 12px;"><span style="background-color: rgb(251, 250, 248); font-size: 12px; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; color: rgb(227, 0, 0); font-weight: bold;">&gt;&gt;&gt;sh = ssh.invoke_shell()</span></span></div><div><span style="font-size: 12px;"><span style="background-color: rgb(251, 250, 248); font-size: 12px; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; color: rgb(227, 0, 0); font-weight: bold;">&gt;&gt;&gt; cmd = open(&quot;test.sh&quot;).read()</span></span></div><div><span style="font-size: 12px;"><span style="background-color: rgb(251, 250, 248); font-size: 12px; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; color: rgb(227, 0, 0); font-weight: bold;">&gt;&gt;&gt; cmd</span></span></div><div><span style="font-size: 12px;"><span style="background-color: rgb(251, 250, 248); font-size: 12px; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-style: italic;">'ll\npwd\ndf\necho &quot;done&quot;\n'</span></span></div><div><span style="font-size: 12px;"><span style="background-color: rgb(251, 250, 248); font-size: 12px; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; color: rgb(227, 0, 0); font-weight: bold;">&gt;&gt;&gt; sh.send(cmd)</span></span></div><div><span style="font-size: 12px;"><span style="background-color: rgb(251, 250, 248); font-size: 12px; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-style: italic;">22</span></span></div><div><span style="font-size: 12px;"><span style="background-color: rgb(251, 250, 248); font-size: 12px; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; color: rgb(227, 0, 0); font-weight: bold;">&gt;&gt;&gt; sh.recv(1000)</span></span></div><div><span style="font-size: 12px;"><span style="background-color: rgb(251, 250, 248); font-size: 12px; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; color: rgb(51, 51, 51); font-style: italic;">b'Last login: Thu Jun 15 01:10:05 2017 from 192.168.180.128\r\r\n[root@localhost ~]# ll\r\ntotal 68\r\n-rw-------. 1 root root  3337 Apr 28 04:54 anaconda-ks.cfg\r\n-rw-r--r--. 1 root root 41364 Apr 28 04:54 install.log\r\n-rw-r--r--. 1 root root  9154 Apr 28 04:52 install.log.syslog\r\n-rw-r--r--. 1 root root    11 Jun 15 01:20 yyc.txt\r\n[root@localhost ~]# pwd\r\n/root\r\n[root@localhost ~]# df\r\nFilesystem     1K-blocks    Used Available Use% Mounted on\r\n/dev/sda2       18339256 2573920  14833752  15% /\r\ntmpfs             502204      84    502120   1% /dev/shm\r\n/dev/sda1         297485   34613    247512  13% /boot\r\n[root@localhost ~]# echo &quot;done&quot;\r\ndone\r\n[root@localhost ~]# '</span></span></div><div><span style="font-size: 12px;"><span style="background-color: rgb(251, 250, 248); font-size: 12px; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; color: rgb(51, 51, 51);">执行脚本不同方便，获取的结果也不是很好。可以封装一个命令。</span></span></div></div><div><span style="font-size: 19px;"><span style="background-color: rgb(255, 250, 165); font-size: 19px;-evernote-highlight:true;">********************************************************************************************************************</span></span></div><div><span style="font-size: 19px;"><span style="background-color: rgb(255, 250, 165); font-size: 19px;-evernote-highlight:true;">使用ansible操作实例及结果</span></span></div><div style="box-sizing: border-box; padding: 8px; font-size: 12px; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);"><div><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;">scp id_rsa.pub  root@192.168.180.130:/root/.ssh/id_rsa.pub  远程传文件，用于公钥分享。</span></div><div><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;">ansible all -m ping --k congshenv5  对于所有/etc/ansible/hosts里面的所有机器执行，-m是指定模块，--k是指定密码，秘钥关联之后是不用密码的。</span></div><div><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;">ansible 192.168.180.128 -m shell -a 'pwd' 对指定ip的机器执行shell模块的命令，-a指定模块参数</span></div><div><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;">ansible-playbook demo.yml --extra-vars &quot;ips=192.168.180.128&quot;  通过ansible的playbook来执行远程命令，ip作为参数传进去，用“,”分隔多个ip</span></div><div><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;">下面是我根据ansible的指令来封装到celery任务里面的cmd</span></div><div><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;">cmd = 'ansible ' + hosts + ' ' +  command          执行单指令，这里比较灵活，可以说完全按原生ansible的指令来封装</span></div><div><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;">cmd = 'ansible ' + hosts + ' -m script -a ' +  script     封装比较高层，只需要输入host和脚本即可，但是这里脚本无法传参</span></div><div><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;">cmd = 'ansible-playbook ' + playbook + ' --extra-vars &quot;ips=' + ips + '&quot;'          指定ip和palybook；</span></div><div><br/></div></div><div><span style="font-size: 19px;"><span style="background-color: rgb(255, 250, 165); font-size: 19px;-evernote-highlight:true;">djcelery任务界面说明</span></span></div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-size: 12px; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);"><div><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;">Task (registered):下拉选择</span></div><div><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;">Task (custom):手写选择，必须是已经注册的任务</span></div><div><br/></div><div><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;">aguement用法</span></div><div><span style="background-color: rgb(251, 250, 248); color: rgb(222, 87, 0); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px; font-weight: bold;">[&quot;192.168.180.131&quot;,&quot;hostname&quot;]</span></div><div><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;">keyword arguements用法</span></div><div><span style="background-color: rgb(251, 250, 248); color: rgb(65, 173, 28); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px; font-weight: bold;">{ &quot;hosts&quot;:&quot;192.168.180.131&quot;, &quot;command&quot;:&quot;ifconfig&quot; }  </span> <span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;">       就是对参数用jason格式</span></div><div><span style="background-color: rgb(251, 250, 248); color: rgb(65, 173, 28); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px; font-weight: bold;">{ &quot;hosts&quot;:&quot;192.168.180.131,192.168.180.128&quot;, &quot;command&quot;:&quot;hostname&quot; }</span> <span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"> 多ip情况</span></div><div><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;">两种方式效果一样，但是第二种看起来会舒服一点</span></div><div><br/></div><div><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;">Execution Options (Hide)说明</span></div><div><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;">Expires  任务过期时间</span></div><div><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;">Queue:指定任务队列</span></div><div><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;">Exchange:指定交换机，交换机觉得任务给哪个队列</span></div><div><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;">Routing key:  路由键</span></div></div><div><br/></div><div><br/></div><div>指定队列指定worker名称</div><div>celery worker -l info -A test_celery -Q low_queue  --autoreload -n worker_lowq</div></div><div><br/></div></span>
</div></body></html> 