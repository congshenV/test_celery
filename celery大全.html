<html>
<head>
  <title>Evernote Export</title>
  <basefont face="微软雅黑" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="Evernote Windows/305825 (zh-CN, DDL); Windows/6.1.7601 Service Pack 1 (Win64);"/>
  <style>
    body, td {
      font-family: 微软雅黑;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="936"/>

<div>
<span><div><div><font style="font-size: 18pt;"><span style="font-size: 18pt; font-weight: bold;">一、Celery实例化及配置</span></font></div><div><font style="font-size: 18pt;"><span style="font-size: 18pt; font-weight: bold;"><br/></span></font></div><div><br/></div><div><span style="font-weight: bold;">1、实例化</span></div><div><br/></div><div>Celery库必须在使用前实例化，这个实例被称为应用程序（或简称为应用程序）。<span style="line-height: 1.45;">应用程序是线程安全的，因此具有不同配置，组件和任务的多个Celery应用程序可以共存在同一进程空间中。</span></div><div>创建celery实例：实例化过程可以为celery指定名字，否则默认为__main__</div><div style="box-sizing: border-box; padding: 8px; font-size: 12px; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);"><div><span style="font-size: 9pt; background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco;">&gt;&gt;&gt; from celery import Celery</span></div><div><span style="font-size: 9pt; background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco;">&gt;&gt;&gt; app = Celery()</span></div><div><span style="font-size: 9pt; background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco;">&gt;&gt;&gt; app</span></div><div><span style="font-size: 9pt; background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco;">&lt;Celery __main__:0x100469fd0&gt;</span></div></div><div><br/></div><div><span style="font-weight: bold;">2、配置</span></div><div><br/></div><div>2.1 设置Celery的配置，通过Celery.conf：</div><div style="box-sizing: border-box; padding: 8px; font-size: 12px; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);"><div><span style="font-size: 9pt; background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco;">&gt;&gt;&gt; app.conf.CELERY_TIMEZONE</span></div><div><span style="font-size: 9pt; background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco;">'Europe/London'</span></div><div><span style="font-size: 9pt; background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco;">#多组</span></div><div><span style="font-size: 9pt; background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco;">&gt;&gt;&gt; app.conf.update(</span></div><div><span style="font-size: 9pt; background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco;">...     CELERY_ENABLE_UTC=True,</span></div><div><span style="font-size: 9pt; background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco;">...     CELERY_TIMEZONE='Europe/London',</span></div><div><span style="font-size: 9pt; background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco;">...)</span></div></div><div>2.2 config文件，通过 <a href="http://docs.jinkan.org/docs/celery/reference/celery.html#celery.Celery.config_from_object" title="celery.Celery.config_from_object">Celery.config_from_object()</a>读取</div><div style="box-sizing: border-box; padding: 8px; font-size: 12px; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);"><div><span style="font-size: 9pt; background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco;">from celery import Celery</span></div><div><span style="font-size: 9pt; background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco;">app = Celery()</span></div><div><span style="font-size: 9pt; background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco;">app.config_from_object('celeryconfig')</span></div></div><div><span style="box-sizing: border-box; font-size: medium; letter-spacing: normal; orphans: auto; text-indent: 0px; text-transform: none; white-space: normal; widows: auto; word-spacing: 0px; -webkit-text-stroke-width: 0px; color: rgb(0, 0, 0); font-family: 微软雅黑; font-variant: normal; line-height: 18px;">2.3 使用config对象设置：</span></div><div style="box-sizing: border-box; padding: 8px; font-size: 12px; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);"><div><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;">from celery import Celery</span></div><div><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;">app = Celery()</span></div><div><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;">class Config:</span></div><div><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;">    CELERY_ENABLE_UTC = True</span></div><div><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;">    CELERY_TIMEZONE = 'Europe/London'</span></div><div><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;">app.config_from_object(Config)</span></div><div><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"># or using the fully qualified name of the object:</span></div><div><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;">#   app.config_from_object('module:Config')</span></div></div><div style="box-sizing: border-box; margin: 0px; padding: 0px;">2.4 Celery.config_from_envvar()从环境变量中读取配置</div><div style="box-sizing: border-box; margin: 0px; padding: 0px;"><div style="box-sizing: border-box; padding: 8px; font-size: 12px; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);"><div><span style="font-size: 9pt; background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco;">import os</span></div><div><span style="font-size: 9pt; background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco;">from celery import Celery</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-size: 9pt; background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco;">#: Set default configuration module name</span></div><div><span style="font-size: 9pt; background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco;">os.environ.setdefault('CELERY_CONFIG_MODULE', 'celeryconfig')</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-size: 9pt; background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco;">app = Celery()</span></div><div><span style="font-size: 9pt; background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco;">app.config_from_envvar('CELERY_CONFIG_MODULE')</span></div></div><div><br/></div></div><div><span style="font-weight: bold; font-size: 10pt;">2、时区、时间</span></div><div><br/></div><div>所有时间和日期，内部和消息都使用UTC时区。</div><div>当WorKer收到消息时，例如使用倒计时设置，将UTC时间转换为本地时间。 如果您希望使用与系统时区不同的时区，则必须使用CELERY_TIMEZONE设置进行配置：</div><div style="box-sizing: border-box; padding: 8px; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);"><div><span style="font-size: 12px; background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">app.conf.CELERY_TIMEZONE = 'Europe/London'</span></div></div><div><br/></div><div><span style="font-size: 18pt; font-weight: bold;">二、Celery创建、启动</span></div><div><br/></div><div><span style="font-weight: bold;">1、创建项目</span></div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-size: 12px; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);"><div><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;">建一个proj项目，目录结构：</span></div><div><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;">proj/__init__.py</span></div><div><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;">    /celery.py</span></div><div><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;">    /tasks.py</span></div></div><div>其中，celery.py， 在此模块中，创建了Celery实例（有时称为应用程序）。 要在项目中使用Celery，只需导入此实例即可。</div><div><br/></div><div>配置参数介绍：broker参数配置消息队列存储后端，backend参数配置结果存储后端。默认情况下，backend是禁用的。include参数是启动时需要导入的模块列表，可以在这里添加我们的任务模块。</div><div><br/></div><div><span style="font-weight: bold;">2、执行worker后输出结果解析</span></div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-size: 12px; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);"><div><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;">$ celery worker --app=proj -l info  启动celery的woker任务执行者</span></div></div><div>    broker即消息队列存储后端；</div><div>    concurrency是prefork同时并发处理任务的数量，默认情况下并发量是cpu数，通过-c参数指定，除了默认的prefork，celery还支持eventlet、gevent、threads等；</div><div>    events，启动时celery会发送监控消息，通过-E管理；</div><div>    queues，多个消息队列；</div><div>    celery worker --help查看命令参数列表</div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-size: 12px; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);"><div><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;">--app参数指定要使用的Celery应用程序实例，它必须以module.path：attribute的形式。</span></div><div><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;">但它也支持一个快捷方式——如果只指定一个包名称，它将尝试按照以下顺序搜索应用程序实例：</span></div><div><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;">例如：使用--app = proj：</span></div><div><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;">     proj.app</span></div><div><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;">     proj.celery</span></div><div><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;">     或者该module中的任何属性，该值属于Celery应用程序，或者如果没有找到该属性，则会尝试名为proj.celery的子模块：</span></div><div><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;">     proj.celery.app</span></div><div><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;">     proj.celery.celery</span></div><div><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;">     或者在proj.celery模块中的任何属性，其值为Celery应用程序。</span></div><div><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;">该方案模拟文档中使用的实践，即单个包含的模块的proj：app，以及较大项目的proj.celery：app。</span></div></div><div><br/></div><div><span style="font-weight: bold;">3、celery multi后台启动worker</span></div><div><br/></div><div>使用celery multi命令启动一个或多个worker在后台。该命令可以start、restart、stop、stopwait， Celery multi不存储有关worker的信息，因此在重新启动时需要使用相同的命令行参数。 停止时，必须使用相同的pidfile和logfile参数。</div><div>默认情况下，它将在当前目录中创建pid和日志文件，以防止多个Worker同时启动，建议您将它们放在专用目录中：</div><div style="box-sizing: border-box; padding: 8px; font-size: 12px; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);"><div><span style="background-color: rgb(251, 250, 248); font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">$ mkdir -p /var/run/celery</span></div><div><span style="background-color: rgb(251, 250, 248); font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">$ mkdir -p /var/log/celery</span></div><div><span style="background-color: rgb(251, 250, 248); font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">$ celery multi start w1 -A proj -l info --pidfile=/var/run/celery/%n.pid \</span></div><div><span style="background-color: rgb(251, 250, 248); font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">                                        --logfile=/var/log/celery/%n.pid</span></div></div><div><br/></div><div>使用Multi命令可以启动多个Worker，并且还有一个强大的命令行语法来为不同的Worker指定参数，例如：</div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-size: 12px; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);"><div><span style="background-color: rgb(251, 250, 248); font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">$ celery multi start 10 -A proj -l info -Q:1-3 images,video -Q:4,5 data \</span></div><div><span style="background-color: rgb(251, 250, 248); font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">    -Q default -L:4,5 debug</span></div></div><div><br/></div><div><span style="font-size: 18pt; font-weight: bold;">三、Celery任务调用</span></div><div><br/></div><div><span style="font-weight: bold;">1、直接调用</span></div><div>通过调用任务的delay()方法，如：</div><div style="box-sizing: border-box; padding: 8px; font-size: 12px; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);"><div><span style="background-color: rgb(251, 250, 248); font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">&gt;&gt;&gt; add.delay(2, 2)</span></div><div><span style="background-color: rgb(251, 250, 248); font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">&gt;&gt;&gt; add.apply_async((2, 2))</span></div></div><div>这个方法其实是apply_async()函数的快捷方式。apply_async()的参数更细化，包括指定队列、运行时间等等。如：</div><div style="box-sizing: border-box; padding: 8px; font-size: 12px; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);"><div><span style="background-color: rgb(251, 250, 248); font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">&gt;&gt;&gt; add.apply_async((2, 2), queue='lopri', countdown=10)</span></div><div><span style="background-color: rgb(251, 250, 248); font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">#在上述示例中，任务将被发送到名为lopri的队列，任务将在消息发送10秒后执行。</span></div></div><div><br/></div><div><span style="font-weight: bold;">2、任务追踪</span></div><div>delay（），apply_async（）和apply（__call__）是Celery调用的API，它们也用于子任务。每个任务调用都将被赋予唯一的标识符（UUID），这是任务ID。 delay和apply_async方法返回一个AsyncResult实例，可以用来跟踪任务的执行状态。 但是，为此，您需要启用结果后端backend，以便将状态存储在某处。</div><div>如果您配置了后端设备，您可以检索任务的返回值：</div><div style="box-sizing: border-box; padding: 8px; font-size: 12px; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);"><div><span style="background-color: rgb(251, 250, 248); font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">&gt;&gt;&gt; res = add.delay(2, 2)</span></div><div><span style="background-color: rgb(251, 250, 248); font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">&gt;&gt;&gt; res.get(timeout=1)</span></div><div><span style="background-color: rgb(251, 250, 248); font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">4</span></div><div><span style="background-color: rgb(251, 250, 248); font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">&gt;&gt;&gt; res.id</span></div><div><span style="background-color: rgb(251, 250, 248); font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">d6b3aea2-fb9b-4ebc-8da4-848818db9114</span></div></div><div>如果任务引发异常，您还可以检查异常和追溯，实际上，result.get（）将默认传播任何错误：</div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-size: 12px; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);"><div><span style="background-color: rgb(251, 250, 248); font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">&gt;&gt;&gt; res = add.delay(2)</span></div><div><span style="background-color: rgb(251, 250, 248); font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">&gt;&gt;&gt; res.get(timeout=1)</span></div><div><span style="background-color: rgb(251, 250, 248); font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">Traceback (most recent call last):</span></div><div><span style="background-color: rgb(251, 250, 248); font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">File &quot;&lt;stdin&gt;&quot;, line 1, in &lt;module&gt;</span></div><div><span style="background-color: rgb(251, 250, 248); font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">File &quot;/opt/devel/celery/celery/result.py&quot;, line 113, in get</span></div><div><span style="background-color: rgb(251, 250, 248); font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">    interval=interval)</span></div><div><span style="background-color: rgb(251, 250, 248); font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">File &quot;/opt/devel/celery/celery/backends/amqp.py&quot;, line 138, in wait_for</span></div><div><span style="background-color: rgb(251, 250, 248); font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">    raise self.exception_to_python(meta['result'])</span></div><div><span style="background-color: rgb(251, 250, 248); font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">TypeError: add() takes exactly 2 arguments (1 given)</span></div></div><div>如果您不希望传播错误，则可以通过传递传播参数来禁用该错误：</div><div style="box-sizing: border-box; padding: 8px; font-size: 12px; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);"><div><span style="background-color: rgb(251, 250, 248); font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">&gt;&gt;&gt; res.get(propagate=False)</span></div><div><span style="background-color: rgb(251, 250, 248); font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">TypeError('add() takes exactly 2 arguments (1 given)',)</span></div></div><div>在这种情况下，它将返回引发的异常实例，因此要检查任务是成功还是失败，您将必须在结果实例上使用相应的方法：</div><div style="box-sizing: border-box; padding: 8px; font-size: 12px; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);"><div><span style="background-color: rgb(251, 250, 248); font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">&gt;&gt;&gt; res.failed()</span></div><div><span style="background-color: rgb(251, 250, 248); font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">True</span></div><div><span style="background-color: rgb(251, 250, 248); font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">&gt;&gt;&gt; res.successful()</span></div><div><span style="background-color: rgb(251, 250, 248); font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">False</span></div></div><div>那么它如何知道任务是否失败？ 可以通过查看任务状态来了解：</div><div style="box-sizing: border-box; padding: 8px; font-size: 12px; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);"><div><span style="background-color: rgb(251, 250, 248); font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">&gt;&gt;&gt; res.state</span></div><div><span style="background-color: rgb(251, 250, 248); font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">'FAILURE'</span></div></div><div>任务只能处于单一状态，但可以通过多个状态进行。 典型任务的阶段可以是：</div><div style="box-sizing: border-box; padding: 8px; font-size: 12px; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);"><div><span style="background-color: rgb(251, 250, 248); font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">PENDING -&gt; STARTED -&gt; SUCCESS</span></div></div><div><br/></div><div>启动状态是一个特殊状态，只有在启用CELERY_TRACK_STARTED设置时才会记录，或者为任务设置了@task（track_started = True）选项。</div><div>挂起状态实际上不是记录状态，而是未知的任何任务ID的默认状态，您可以从此示例中看到：</div><div style="box-sizing: border-box; padding: 8px; font-size: 12px; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);"><div><span style="background-color: rgb(251, 250, 248); font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">&gt;&gt;&gt; from proj.celery import app</span></div><div><span style="background-color: rgb(251, 250, 248); font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">&gt;&gt;&gt; res = app.AsyncResult('this-id-does-not-exist')</span></div><div><span style="background-color: rgb(251, 250, 248); font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">&gt;&gt;&gt; res.state</span></div><div><span style="background-color: rgb(251, 250, 248); font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">'PENDING'</span></div></div><div>如果任务被重试，这些阶段可能变得更复杂，例如，对于重试两次阶段的任务：</div><div style="box-sizing: border-box; padding: 8px; font-size: 12px; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);"><div><span style="background-color: rgb(251, 250, 248); font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">PENDING -&gt; STARTED -&gt; RETRY -&gt; STARTED -&gt; RETRY -&gt; STARTED -&gt; SUCCESS</span></div></div><div><br/></div><div><span style="font-weight: bold;">3、任务传递</span></div><div><br/></div><div>您刚刚学习了如何使用tasks delay方法调用任务，这是一般需求，但有时我们希望将任务调用的签名传递给另一个进程，或者将其作为另一个函数的参数传递给该Celery，这就是称为子任务的东西。</div><div>子任务以一种方式包装单个任务调用的参数和执行选项，使其可以传递给函数，甚至可以串行化并通过电子邮件发送。</div><div>您可以使用参数（2，2）创建添加任务的子任务，并且如下所示为10秒的倒数：</div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-size: 12px; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);"><div><span style="background-color: rgb(251, 250, 248); font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">&gt;&gt;&gt; add.subtask((2, 2), countdown=10)</span></div><div><span style="background-color: rgb(251, 250, 248); font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">tasks.add(2, 2)</span></div><div><span style="background-color: rgb(251, 250, 248); font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">#快捷方式</span></div><div><span style="background-color: rgb(251, 250, 248); font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">&gt;&gt;&gt; add.s(2, 2)</span></div><div><span style="background-color: rgb(251, 250, 248); font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">tasks.add(2, 2)</span></div></div><div><br/></div><div>子任务实例还支持调用API，这意味着它们具有延迟和apply_async方法。</div><div>但是有一个区别在于子任务可能已经具有指定的参数签名。 添加任务需要两个参数，因此指定两个参数的子任务将完成一个签名：</div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-size: 12px; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);"><div><span style="background-color: rgb(251, 250, 248); font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">&gt;&gt;&gt; s1 = add.s(2, 2)</span></div><div><span style="background-color: rgb(251, 250, 248); font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">&gt;&gt;&gt; res = s1.delay()</span></div><div><span style="background-color: rgb(251, 250, 248); font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">&gt;&gt;&gt; res.get()</span></div><div><span style="background-color: rgb(251, 250, 248); font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">4</span></div></div><div>但是，您也可以创建不完整的signatures来创建我们所谓的部分内容：</div><div style="box-sizing: border-box; padding: 8px; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);"><div><span style="font-size: 12px; background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"># incomplete partial: add(?, 2)&gt;&gt;&gt; s2 = add.s(2)</span></div></div><div>s2现在是一个部分子任务，需要另一个参数才能完成，调用子任务时可以解决这个问题：</div><div style="box-sizing: border-box; padding: 8px; font-size: 12px; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);"><div><span style="background-color: rgb(251, 250, 248); font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"># resolves the partial: add(8, 2)</span></div><div><span style="background-color: rgb(251, 250, 248); font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">&gt;&gt;&gt; res = s2.delay(8)</span></div><div><span style="background-color: rgb(251, 250, 248); font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">&gt;&gt;&gt; res.get()</span></div><div><span style="background-color: rgb(251, 250, 248); font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">10</span></div></div><div>在这里，你添加了参数8，它已经被添加到现有参数2中，形成了一个完整的add（8,2）签名。</div><div>关键字参数也可以稍后添加，然后将它们与任何现有的关键字参数进行合并，但以新的参数为优先：</div><div style="box-sizing: border-box; padding: 8px; font-size: 12px; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);"><div><span style="background-color: rgb(251, 250, 248); font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">&gt;&gt;&gt; s3 = add.s(2, 2, debug=True)</span></div><div><span style="background-color: rgb(251, 250, 248); font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">&gt;&gt;&gt; s3.delay(debug=False)  # debug is now False.</span></div></div><div>如所述子任务支持调用API，这意味着：</div><div style="box-sizing: border-box; padding: 8px; font-size: 12px; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);"><div><span style="background-color: rgb(251, 250, 248); font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">subtask.apply_async(args=(), kwargs={}, **options)</span></div></div><div>使用可选的部分参数和部分关键字参数调用子任务。 还支持部分执行选项。</div><div style="box-sizing: border-box; padding: 8px; font-size: 12px; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);"><div><span style="background-color: rgb(251, 250, 248); font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">subtask.delay(*args, **kwargs)</span></div></div><div>apply_async的Star参数版本。 任何参数都将添加到签名中的参数中，并且关键字参数与任何现有的键合并。</div><div>所以这一切似乎都是非常有用的，但是你可以做些什么呢？ 为了达到这一点，我必须介绍canvas primitives...</div><div><br/></div><div><span style="font-weight: bold;">4、</span><span style="background-color: rgb(255, 250, 165); font-size: 19px; font-weight: bold;-evernote-highlight:true;">The Primitives</span></div><div>原语Primitives本身就是子任务，因此它们可以以多种方式组合起来，以构成复杂的工作流程。</div><div>Groups</div><div>一个组并行调用任务列表，它返回一个特殊的结果实例，可以将结果作为一组进行检查，并按顺序检索返回值。</div><div style="box-sizing: border-box; padding: 8px; font-size: 12px; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);"><div><span style="background-color: rgb(251, 250, 248); font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">&gt;&gt;&gt; from celery import group</span></div><div><span style="background-color: rgb(251, 250, 248); font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">&gt;&gt;&gt; from proj.tasks import add</span></div><div><span style="background-color: rgb(251, 250, 248); font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">&gt;&gt;&gt; group(add.s(i, i) for i in xrange(10))().get()</span></div><div><span style="background-color: rgb(251, 250, 248); font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">[0, 2, 4, 6, 8, 10, 12, 14, 16, 18]</span></div></div><div>Partial group</div><div style="box-sizing: border-box; padding: 8px; font-size: 12px; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);"><div><span style="background-color: rgb(251, 250, 248); font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">&gt;&gt;&gt; g = group(add.s(i) for i in xrange(10))</span></div><div><span style="background-color: rgb(251, 250, 248); font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">&gt;&gt;&gt; g(10).get()</span></div><div><span style="background-color: rgb(251, 250, 248); font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">[10, 11, 12, 13, 14, 15, 16, 17, 18, 19]</span></div></div><div>Chains</div><div>任务可以链接在一起，以便在一个任务返回后调用另一个任务：</div><div style="box-sizing: border-box; padding: 8px; font-size: 12px; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);"><div><span style="background-color: rgb(251, 250, 248); font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">&gt;&gt;&gt; from celery import chain</span></div><div><span style="background-color: rgb(251, 250, 248); font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">&gt;&gt;&gt; from proj.tasks import add, mul</span></div><div><br/></div><div><span style="background-color: rgb(251, 250, 248); font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"># (4 + 4) * 8</span></div><div><span style="background-color: rgb(251, 250, 248); font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">&gt;&gt;&gt; chain(add.s(4, 4) | mul.s(8))().get()</span></div><div><span style="background-color: rgb(251, 250, 248); font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">64</span></div></div><div>or a partial chain:</div><div style="box-sizing: border-box; padding: 8px; font-size: 12px; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);"><div><span style="background-color: rgb(251, 250, 248); font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"># (? + 4) * 8</span></div><div><span style="background-color: rgb(251, 250, 248); font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">&gt;&gt;&gt; g = chain(add.s(4) | mul.s(8))</span></div><div><span style="background-color: rgb(251, 250, 248); font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">&gt;&gt;&gt; g(4).get()</span></div><div><span style="background-color: rgb(251, 250, 248); font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">64</span></div></div><div>链也可以这样写：</div><div style="box-sizing: border-box; padding: 8px; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);"><div><span style="font-size: 12px; background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">&gt;&gt;&gt; (add.s(4, 4) | mul.s(8))().get()</span></div><div><span style="font-size: 12px; background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">64</span></div></div><div>Chords</div><div>Chords是具有回调的组：</div><div style="box-sizing: border-box; padding: 8px; font-size: 12px; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);"><div><span style="background-color: rgb(251, 250, 248); font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">&gt;&gt;&gt; from celery import chord</span></div><div><span style="background-color: rgb(251, 250, 248); font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">&gt;&gt;&gt; from proj.tasks import add, xsum</span></div><div><br/></div><div><span style="background-color: rgb(251, 250, 248); font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">&gt;&gt;&gt; chord((add.s(i, i) for i in xrange(10)), xsum.s())().get()</span></div><div><span style="background-color: rgb(251, 250, 248); font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">90</span></div></div><div>链接到另一个任务的组将被自动转换为和弦：</div><div style="box-sizing: border-box; padding: 8px; font-size: 12px; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);"><div><span style="background-color: rgb(251, 250, 248); font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">&gt;&gt;&gt; (group(add.s(i, i) for i in xrange(10)) | xsum.s())().get()</span></div><div><span style="background-color: rgb(251, 250, 248); font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">90</span></div></div><div>由于这些原语都是子任务类型，所以几乎可以将它们组合起来，例如：</div><div style="box-sizing: border-box; padding: 8px; font-size: 12px; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);"><div><span style="background-color: rgb(251, 250, 248); font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">&gt;&gt;&gt; upload_document.s(file) | group(apply_filter.s() for filter in filters)</span></div></div><div>Routing</div><div>Celery支持AMQP提供的所有路由设施，但它也支持将消息发送到命名队列的简单路由。</div><div>CELERY_ROUTES设置使您能够按名称路由任务，并将所有内容集中在一个位置：</div><div style="box-sizing: border-box; padding: 8px; font-size: 12px; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);"><div><span style="background-color: rgb(251, 250, 248); font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">app.conf.update(</span></div><div><span style="background-color: rgb(251, 250, 248); font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">    CELERY_ROUTES = {</span></div><div><span style="background-color: rgb(251, 250, 248); font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">        'proj.tasks.add': {'queue': 'hipri'},</span></div><div><span style="background-color: rgb(251, 250, 248); font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">    },</span></div><div><span style="background-color: rgb(251, 250, 248); font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">)</span></div></div><div>您还可以在运行时使用apply_async的queue参数指定队列：</div><div style="box-sizing: border-box; padding: 8px; font-size: 12px; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);"><div><span style="background-color: rgb(251, 250, 248); font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">&gt;&gt;&gt; from proj.tasks import add</span></div><div><span style="background-color: rgb(251, 250, 248); font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">&gt;&gt;&gt; add.apply_async((2, 2), queue='hipri')</span></div></div><div>然后，您可以通过指定-Q选项使员工从此队列中消耗：</div><div style="box-sizing: border-box; padding: 8px; font-size: 12px; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);"><div><span style="background-color: rgb(251, 250, 248); font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">$ celery -A proj worker -Q hipri</span></div></div><div>您可以通过使用逗号分隔列表来指定多个队列，例如，您可以使工作人员从缺省队列和hipri队列中消费，其中默认队列名为celery，因为历史原因：</div><div style="box-sizing: border-box; padding: 8px; font-size: 12px; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);"><div><span style="background-color: rgb(251, 250, 248); font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">$ celery -A proj worker -Q hipri,celery</span></div></div><div>队列的顺序并不重要，因为工作人员将对队列给予相等的权重。</div><div><br/></div><div><span style="font-size: 18pt; font-weight: bold;">四、Celery实用命令行</span></div><div><span style="font-size: 18pt; font-weight: bold;"><br/></span></div><div><span style="font-weight: bold;"><font style="font-size: 10pt;">1、命令行帮助</font></span></div><div><span style="color: rgb(255, 0, 0); font-weight: bold;">用法: celery &lt;command&gt; [options]</span></div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;-en-codeblock:true;"><div><span style="font-weight: bold;"><span style="color: rgb(255, 0, 0); font-weight: bold; font-family: Monaco; font-size: 9pt;">celery <span style="color: rgb(255, 0, 0); font-weight: bold; font-family: Monaco; font-size: 9pt;">-h, --help             显示此帮助消息并退出</span></span></span></div><div><span style="color: rgb(255, 0, 0); font-weight: bold; font-family: Monaco; font-size: 9pt;"><span style="color: rgb(255, 0, 0); font-weight: bold; font-family: Monaco; font-size: 9pt;"><span>    <span>    <span>    <span style="color: rgb(255, 0, 0); font-weight: bold; font-family: Monaco; font-size: 9pt;">--version              显示程序的版本号并退出</span></span></span></span><br/></span></span></div></div><div><span style="font-weight: bold;"><font style="font-size: 10pt;"><br/></font></span></div><div><span style="font-weight: bold;"><font style="font-size: 10pt;">2、命令类型</font></span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;-en-codeblock:true;"><div><span style="color: rgb(255, 0, 0);">|    celery worker<span>  </span><span>-n --hostname 自定义worker名字，可以扩展<span style="color: rgb(156, 0, 76); font-family: Monaco; font-size: 9pt;">(如, 'worker@%h'). 扩展: %h</span><span style="color: rgb(156, 0, 76); font-family: Monaco; font-size: 9pt;"> (hostname), %n (name) and %d, (domain).</span></span></span></div><div><span style="color: rgb(255, 0, 0);"><span style="color: rgb(156, 0, 76); font-family: Monaco; font-size: 9pt;"><span>    <span>    <span>    <span>    <span>    <span>    <span>    <span>   <span>  </span> <span> <span style="color: rgb(156, 0, 76); font-family: Monaco; font-size: 9pt;">-D, --detach<span>    <span>    <span style="font-family: Monaco; font-size: 9pt; color: rgb(156, 0, 76);">启动worker作为后台进程。</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></div><div><span style="color: rgb(255, 0, 0);"><span style="color: rgb(156, 0, 76); font-family: Monaco; font-size: 9pt;"><span style="color: rgb(156, 0, 76); font-family: Monaco; font-size: 9pt;"><span style="font-family: Monaco; font-size: 9pt; color: rgb(156, 0, 76);"><span style="color: rgb(156, 0, 76); font-family: Monaco; font-size: 9pt;"><span style="font-family: Monaco; font-size: 9pt; color: rgb(156, 0, 76);"><span>    <span>    <span>    <span>    <span>    <span>    <span>    <span>    <span>   <span style="color: rgb(156, 0, 76); font-family: Monaco; font-size: 9pt;">-l LOGLEVEL, --loglevel LOGLEVEL   <span style="font-family: Monaco; font-size: 9pt; color: rgb(156, 0, 76);">日志级别，选择</span><span style="color: rgb(156, 0, 76); font-family: Monaco; font-size: 9pt;">DEBUG, INFO, WARNING,</span><span style="color: rgb(156, 0, 76); font-family: Monaco; font-size: 9pt;">ERROR, CRITICAL, or FATAL.</span></span></span></span></span></span></span></span></span></span></span><br/></span></span></span></span></span></span></div><div><span style="color: rgb(255, 0, 0);"><span style="color: rgb(156, 0, 76); font-family: Monaco; font-size: 9pt;"><span style="color: rgb(156, 0, 76); font-family: Monaco; font-size: 9pt;"><span style="font-family: Monaco; font-size: 9pt; color: rgb(156, 0, 76);"><span style="color: rgb(156, 0, 76); font-family: Monaco; font-size: 9pt;"><span style="font-family: Monaco; font-size: 9pt; color: rgb(156, 0, 76);"><span style="color: rgb(156, 0, 76); font-family: Monaco; font-size: 9pt;"><span style="color: rgb(156, 0, 76); font-family: Monaco; font-size: 9pt;"><span>    <span>    <span>    <span>    <span>    <span>    <span>    <span>    <span>   <span style="color: rgb(156, 0, 76); font-family: Monaco; font-size: 9pt;">-c CONCURRENCY, --concurrency CONCURRENCY<span>    <span>    <span style="font-family: Monaco; font-size: 9pt; color: rgb(156, 0, 76);">处理队列的子进程数。默认值是系统上可用的CPU数量。</span></span></span></span></span></span></span></span></span></span></span></span></span><br/></span></span></span></span></span></span></span></span></div><div><span style="color: rgb(255, 0, 0);"><span style="color: rgb(156, 0, 76); font-family: Monaco; font-size: 9pt;"><span style="color: rgb(156, 0, 76); font-family: Monaco; font-size: 9pt;"><span style="font-family: Monaco; font-size: 9pt; color: rgb(156, 0, 76);"><span style="color: rgb(156, 0, 76); font-family: Monaco; font-size: 9pt;"><span style="font-family: Monaco; font-size: 9pt; color: rgb(156, 0, 76);"><span style="color: rgb(156, 0, 76); font-family: Monaco; font-size: 9pt;"><span style="color: rgb(156, 0, 76); font-family: Monaco; font-size: 9pt;"><span style="color: rgb(156, 0, 76); font-family: Monaco; font-size: 9pt;"><span style="font-family: Monaco; font-size: 9pt; color: rgb(156, 0, 76);"><span>    <span>    <span>    <span>    <span>    <span>    <span>    <span>    <span>   <span style="font-size: medium; letter-spacing: normal; orphans: auto; text-indent: 0px; text-transform: none; white-space: normal; widows: auto; word-spacing: 0px; -webkit-text-stroke-width: 0px; color: rgb(156, 0, 76); font-family: 微软雅黑; font-variant: normal;">--queues QUEUES, -Q QUEUES<span>    <span>    要为此worker启用的队列列表，用逗号分隔。缺省情况下，所有配置的队列都被使能。</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span style="line-height: 1.45;">例如：</span><span style="line-height: 1.45; color: rgb(156, 0, 76);">-Q video,image</span></div><div><span style="line-height: 1.45; color: rgb(156, 0, 76);"><span>    <span>    <span>    <span>    <span>    <span style="color: rgb(156, 0, 76); font-family: Monaco; font-size: 9pt;">--exclude-queues EXCLUDE_QUEUES, -X EXCLUDE_QUEUES<span>    <span>    此worker禁用的队列列表，用逗号分隔。缺省情况下，所有配置的队列都被使能。</span></span></span></span></span></span></span></span></span><span style="line-height: 1.45;">例如：</span><span style="line-height: 1.45; color: rgb(156, 0, 76);">-X video,image.</span></div><div><span style="line-height: 1.45; color: rgb(156, 0, 76);"><span>    <span>    <span>    <span>    <span>    <span style="color: rgb(156, 0, 76); font-family: Monaco; font-size: 9pt;">--include INCLUDE, -I INCLUDE    逗号分隔的要导入的其他模块列表。</span></span></span></span></span></span></span><span style="line-height: 1.45;">例如：</span><span style="line-height: 1.45; color: rgb(156, 0, 76);">-I foo.tasks,bar.tasks</span></div><div><span style="line-height: 1.45; color: rgb(156, 0, 76);"><span>    <span>    <span>    <span>    <span>    <span style="color: rgb(156, 0, 76); font-family: Monaco; font-size: 9pt;">--autoscale AUTOSCALE<span>    <span>    通过提供max_concurrency，min_concurrency启用自动缩放功能。</span></span></span></span></span></span></span></span></span><span style="line-height: 1.45;">例如：</span><span style="line-height: 1.45; color: rgb(156, 0, 76);">--autoscale=10,3（</span> <span style="line-height: 1.45;">始终保持3个进程，但如果需要，增长到10个</span><span style="line-height: 1.45; color: rgb(156, 0, 76);">）</span></div><div><span style="line-height: 1.45; color: rgb(156, 0, 76);"><span>    <span>    <span>    <span>    <span>    <span style="color: rgb(156, 0, 76); font-family: Monaco; font-size: 9pt;">-f LOGFILE, --logfile LOGFILE<span>    <span>    <span style="font-family: Monaco; font-size: 9pt; color: rgb(156, 0, 76);">日志文件的路径。 如果没有指定logfile，则使用stderr。</span></span></span></span></span></span></span></span></span><br/></span></div><div><span style="line-height: 1.45; color: rgb(156, 0, 76);"><span style="color: rgb(156, 0, 76); font-family: Monaco; font-size: 9pt;"><span style="font-family: Monaco; font-size: 9pt; color: rgb(156, 0, 76);"><span>    <span>    <span>    <span>    <span>    <span>    <span>    <span>    <span>   <span style="color: rgb(156, 0, 76); font-family: Monaco; font-size: 9pt;">--pidfile PIDFILE <span>    <span>    <span>    <span>    <span style="font-family: Monaco; font-size: 9pt; color: rgb(156, 0, 76);">可选文件用于存储进程pid。 如果此文件已存在且pid仍然存在，程序将无法启动。</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><br/></span></span></span></div><div><span style="line-height: 1.45; color: rgb(156, 0, 76);"><span style="color: rgb(156, 0, 76); font-family: Monaco; font-size: 9pt;"><span style="font-family: Monaco; font-size: 9pt; color: rgb(156, 0, 76);"><span style="color: rgb(156, 0, 76); font-family: Monaco; font-size: 9pt;"><span style="font-family: Monaco; font-size: 9pt; color: rgb(156, 0, 76);"><span>    <span>    <span>    <span>    <span>    <span>    <span>    <span>    <span>   <span style="color: rgb(156, 0, 76); font-family: Monaco; font-size: 9pt;">-B, --beat <span>    <span>    <span>    <span>    <span>    <span>    还要运行Celery beat定期任务调度程序。请注意，这个服务只能有一个实例。</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span style="line-height: 1.45;">注意:: -B旨在用于开发目的。 对于生产环境，您需要单独启动Celery。</span></div><div><span style="line-height: 1.45;"><span>    <span>    <span>    <span> <span style="color: rgb(156, 0, 76); font-family: Monaco; font-size: 9pt;">-s SCHEDULE_FILENAME, --schedule-filename SCHEDULE_FILENAME, --schedule SCHEDULE_FILENAME<span>    <span>    <span style="font-family: Monaco; font-size: 9pt; color: rgb(156, 0, 76);">使用-B选项运行时调度数据库的路径。 默认为celerybeat-schedule。 扩展名“.db”可以附加到文件名。 应用优化配置文件。 支持：</span><span style="color: rgb(156, 0, 76); font-family: Monaco; font-size: 9pt;">default, fair</span></span></span></span></span></span></span></span><br/></span></div><div><span style="color: rgb(255, 0, 0);"><span>    <span>    <span>    <span>        <span style="color: rgb(156, 0, 76); font-family: Monaco; font-size: 9pt;">--scheduler SCHEDULER  <span style="font-family: Monaco; font-size: 9pt; color: rgb(156, 0, 76);">要使用的Scheduler类。 默认值为celery.beat.PersistentScheduler</span></span></span></span></span></span></span></div><div><span style="color: rgb(255, 0, 0);">|    celery events<span>  <span style="font-family: Monaco; font-size: 9pt; color: rgb(255, 0, 0);">-d, --dump            将事件发至stdout.</span></span></span></div><div><span style="color: rgb(255, 0, 0);"><span style="font-family: Monaco; font-size: 9pt; color: rgb(255, 0, 0);"><span>    <span>    <span>    <span>                       <span style="font-family: Monaco; font-size: 9pt; color: rgb(255, 0, 0);">--detach              Camera: 在后台分离并作为守护进程运行。</span></span></span></span></span><br/></span></span></div><div><span style="color: rgb(255, 0, 0);"><span style="font-family: Monaco; font-size: 9pt; color: rgb(255, 0, 0);"><span style="font-family: Monaco; font-size: 9pt; color: rgb(255, 0, 0);">                                   <span style="font-family: Monaco; font-size: 9pt; color: rgb(255, 0, 0);"> -l LOGLEVEL, --loglevel LOGLEVEL 日志等级</span></span></span></span></div><div><span style="color: rgb(255, 0, 0);"><span style="font-family: Monaco; font-size: 9pt; color: rgb(255, 0, 0);"><span style="font-family: Monaco; font-size: 9pt; color: rgb(255, 0, 0);"><span style="font-family: Monaco; font-size: 9pt; color: rgb(255, 0, 0);">                                    </span></span></span></span></div><div><span style="color: rgb(255, 0, 0);">|    celery beat<span>    <span>    <span style="color: rgb(255, 0, 0); font-family: Monaco; font-size: 9pt;">--detach              </span> <span style="font-family: Monaco; font-size: 9pt; color: rgb(255, 0, 0);">分离并在后台运行作为守护进程。</span></span></span></span></div><div><span style="color: rgb(255, 0, 0);"><span style="font-family: Monaco; font-size: 9pt; color: rgb(255, 0, 0);"><span>    <span>    <span>    <span>    <span>    <span>    <span>    <span>    <span>    <span>    <span>  <span style="color: rgb(255, 0, 0); font-family: Monaco; font-size: 9pt;">-s SCHEDULE, --schedule SCHEDULE  <span style="font-family: Monaco; font-size: 9pt; color: rgb(255, 0, 0);">路径数据库。 默认为celerybeat- schedule。 扩展名'.db'可以附加到文件名。 默认是celerybeat-schedule。</span></span></span></span></span></span></span></span></span></span></span></span></span><br/></span></span></div><div><span style="color: rgb(255, 0, 0);"><span style="font-family: Monaco; font-size: 9pt; color: rgb(255, 0, 0);"><span style="color: rgb(255, 0, 0); font-family: Monaco; font-size: 9pt;"><span style="font-family: Monaco; font-size: 9pt; color: rgb(255, 0, 0);"><span>    <span>    <span>    <span>    <span>    <span>    <span>    <span>    <span>    <span>      <span style="color: rgb(255, 0, 0); font-family: Monaco; font-size: 9pt;">-S SCHEDULER, --scheduler SCHEDULER   <span style="font-family: Monaco; font-size: 9pt; color: rgb(255, 0, 0);">要使用的Scheduler类。 默认值为celery.beat.PersistentScheduler。</span></span></span></span></span></span></span></span></span></span></span></span><br/></span></span></span></span></div><div><span style="color: rgb(255, 0, 0);"><span style="font-family: Monaco; font-size: 9pt; color: rgb(255, 0, 0);"><span style="color: rgb(255, 0, 0); font-family: Monaco; font-size: 9pt;"><span style="font-family: Monaco; font-size: 9pt; color: rgb(255, 0, 0);"><span style="color: rgb(255, 0, 0); font-family: Monaco; font-size: 9pt;"><span style="font-family: Monaco; font-size: 9pt; color: rgb(255, 0, 0);"><span>    <span>    <span>    <span>    <span>    <span>    <span>    <span>    <span>    <span>      <span style="color: rgb(255, 0, 0); font-family: Monaco; font-size: 9pt;">-l LOGLEVEL, --loglevel LOGLEVEL   <span style="color: rgb(255, 0, 0); font-family: Monaco; font-size: 9pt;">日志级别，选择 DEBUG, INFO, WARNING,</span> <span style="color: rgb(255, 0, 0); font-family: Monaco; font-size: 9pt;">ERROR, CRITICAL, or FATAL.</span></span></span></span></span></span></span></span></span></span></span></span><br/></span></span></span></span></span></span></div><div><span style="color: rgb(255, 0, 0);">|    celery shell</span></div><div><span style="color: rgb(255, 0, 0);">|    celery multi<span>    <span>    </span></span></span></div><div><span style="color: rgb(255, 0, 0);">|    celery amqp</span></div><div><span style="color: rgb(255, 0, 0);">远程控制：</span></div><div><span style="color: rgb(255, 0, 0);">|    celery status</span></div><div><span style="color: rgb(255, 0, 0);">|    celery inspect --help  一系列</span></div><div><span style="color: rgb(255, 0, 0); font-family: Monaco; font-size: 9pt;"><span style="color: rgb(255, 0, 0); font-family: Monaco; font-size: 9pt;">|</span>    celery control --help<span>    <span>    <span>    <span>    一系列</span></span></span></span></span></div><div><span style="color: rgb(255, 0, 0);">+ 实用工具:</span></div><div><span style="color: rgb(255, 0, 0);">|    celery purge</span></div><div><span style="color: rgb(255, 0, 0);">|    celery list</span></div><div><span style="color: rgb(255, 0, 0);">|    celery call</span></div><div><span style="color: rgb(255, 0, 0);">|    celery result</span></div><div><span style="color: rgb(255, 0, 0);">|    celery migrate</span></div><div><span style="color: rgb(255, 0, 0);">|    celery graph</span></div><div><span style="color: rgb(255, 0, 0);">|    celery upgrade</span></div><div><span style="color: rgb(255, 0, 0);">+ 调试工具:</span></div><div><span style="color: rgb(255, 0, 0);">|    celery report</span></div><div><span style="color: rgb(255, 0, 0);">|    celery logtool</span></div></div><div><br/></div><div><b>3、参数</b></div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;-en-codeblock:true;"><div><span style="color: rgb(255, 0, 0);">全局选项:</span></div><div><span style="color: rgb(255, 0, 0);">  -A APP, --app APP    <span>    <span>    <span>    <span> </span></span></span></span>指定celery实例，如：<span style="box-sizing: border-box; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">--app=proj   或：<span style="box-sizing: border-box; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">-A proj</span></span></span></div><div><span style="color: rgb(255, 0, 0);">  -b BROKER, --broker BROKER<span>    <span>    指定</span></span></span></div><div><span style="color: rgb(255, 0, 0);">  --loader LOADER</span></div><div><span style="color: rgb(255, 0, 0);">  --config CONFIG</span></div><div><span style="color: rgb(255, 0, 0);">  --workdir WORKDIR</span></div><div><span style="color: rgb(255, 0, 0);">  --no-color, -C<span>    <span>    <span>    <span>    不<span style="font-family: Monaco; font-size: 9pt; color: rgb(255, 0, 0);">显示颜色</span></span></span></span></span></span></div><div><span style="color: rgb(255, 0, 0);">  --quiet, -q<span>    <span>    <span>    <span>    <span style="font-family: Monaco; font-size: 9pt; color: rgb(255, 0, 0);">不显示过多输出</span><span style="color: rgb(255, 0, 0); font-family: Monaco; font-size: 9pt;">.</span></span></span></span></span></span></div><div><span style="color: rgb(255, 0, 0); font-family: Monaco; font-size: 9pt;">--verbose:    </span> <span style="font-family: Monaco; font-size: 9pt; color: rgb(255, 0, 0);">显示更多的输出</span></div><div><span style="color: rgb(255, 0, 0); font-family: Monaco; font-size: 9pt;">--nosplash:   </span> <span style="font-family: Monaco; font-size: 9pt; color: rgb(255, 0, 0);">不显示程序信息</span></div></div><div><br/></div><div><span style="font-weight: bold;">3、操作实例</span></div><div><span style="font-weight: bold;"><br/></span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;-en-codeblock:true;"><div><span style="box-sizing: border-box; font-size: 12px; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">前台启动，<span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">——如果希望使用守护程序在后台启动，参考</span><a href="http://docs.jinkan.org/docs/celery/tutorials/daemonizing.html#daemonizing" style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">http://docs.jinkan.org/docs/celery/tutorials/daemonizing.html#daemonizing</a></span></div><div><span style="box-sizing: border-box; font-size: 12px; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">$ celery --app=app worker -l info</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">$ celery worker --help</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">启动多个worker</span></div><div><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;">$ celery worker --loglevel=INFO --concurrency=10 -n worker1.%h</span></div><div><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;">$ celery worker --loglevel=INFO --concurrency=10 -n worker2.%h</span></div><div><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;">$ celery worker --loglevel=INFO --concurrency=10 -n worker3.%h</span></div><ul><li><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;">％h：主机名，包括域名。</span></li><li><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;">％n：仅主机名。</span></li><li><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;">％d：仅限域名。</span></li></ul><div>如果当前主机名是<a href="http://george.example.com/">george.example.com</a>，那么这些主机名将扩展为：</div><div><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;">- worker1.%h -&gt; <a href="http://worker1.george.example.com/">worker1.george.example.com</a></span></div><div><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;">- worker1.%n -&gt; worker1.george</span></div><div><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;">- worker1.%d -&gt; <a href="http://worker1.example.com/">worker1.example.com</a></span></div><div><br/></div><div><br/></div></div><div><br/></div><div><span style="font-weight: bold;">4、远程控制</span></div><div>如果您使用RabbitMQ（AMQP），Redis或MongoDB作为代理，那么您可以在运行时控制和检查工作。例如，可以查看worker正在处理的任务</div><div style="box-sizing: border-box; padding: 8px; font-size: 12px; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);"><div><span style="background-color: rgb(251, 250, 248); font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">$ celery -A proj inspect active</span></div></div><div>这是通过使用广播消息传递来实现的，因此所有远程控制命令都由群集中的每个工作人员接收。</div><div>您还可以使用--destination选项指定一个或多个工作者对请求进行操作，该选项是以逗号分隔的工作主机名列表：</div><div style="box-sizing: border-box; padding: 8px; font-size: 12px; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);"><div><span style="background-color: rgb(251, 250, 248); font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">$ celery -A proj inspect active --destination=<a href="mailto:celery@example.com" style="background-color: rgb(251, 250, 248); font-size: 12px; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">celery@example.com</a></span></div></div><div>如果没有提供目的地，那么每个worker都将采取行动并回复该请求。</div><div>celery检查命令包含不改变任何工作的任何命令，它只会回复关于worker内部正在发生的信息和统计信息。有关可以执行的检查命令的列表：</div><div style="box-sizing: border-box; padding: 8px; font-size: 12px; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);"><div><span style="background-color: rgb(251, 250, 248); font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">$ celery -A proj inspect --help</span></div></div><div>然后是Celery控件命令，其中包含在运行时实际更改worker中的内容的命令：</div><div style="box-sizing: border-box; padding: 8px; font-size: 12px; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);"><div><span style="background-color: rgb(251, 250, 248); font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">$ celery -A proj control --help</span></div></div><div>例如，您可以强制WOrkers启用事件消息（用于监视任务和wokers）：</div><div style="box-sizing: border-box; padding: 8px; font-size: 12px; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);"><div><span style="background-color: rgb(251, 250, 248); font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">$ celery -A proj control enable_events</span></div></div><div>当启用事件时，您可以启动事件转储程序来查看WorKers正在执行的操作：</div><div style="box-sizing: border-box; padding: 8px; font-size: 12px; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);"><div><span style="background-color: rgb(251, 250, 248); font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">$ celery -A proj events --dump</span></div></div><div>或者你可以启动curses界面：</div><div style="box-sizing: border-box; padding: 8px; font-size: 12px; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);"><div><span style="background-color: rgb(251, 250, 248); font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">$ celery -A proj events</span></div></div><div>完成监控后，您可以再次禁用事件：</div><div style="box-sizing: border-box; padding: 8px; font-size: 12px; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);"><div><span style="background-color: rgb(251, 250, 248); font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">$ celery -A proj control disable_events</span></div></div><div>Celery status命令还使用远程控制命令，并显示集群中的在线WorKers列表：</div><div style="box-sizing: border-box; padding: 8px; font-size: 12px; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);"><div><span style="background-color: rgb(251, 250, 248); font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">$ celery -A proj status</span></div></div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;-en-codeblock:true;"><div><span style="color: rgb(255, 0, 0);">|    celery inspect --help</span></div><div><span style="color: rgb(255, 0, 0);">|    celery inspect active</span></div><div><span style="color: rgb(255, 0, 0);">|    celery inspect active_queues</span></div><div><span style="color: rgb(255, 0, 0);">|    celery inspect clock</span></div><div><span style="color: rgb(255, 0, 0);">|    celery inspect conf [include_defaults=False]</span></div><div><span style="color: rgb(255, 0, 0);">|    celery inspect memdump [n_samples=10]</span></div><div><span style="color: rgb(255, 0, 0);">|    celery inspect memsample</span></div><div><span style="color: rgb(255, 0, 0);">|    celery inspect objgraph [object_type=Request] [num=200 [max_depth=10]]</span></div><div><span style="color: rgb(255, 0, 0);">|    celery inspect ping</span></div><div><span style="color: rgb(255, 0, 0);">|    celery inspect query_task [id1 [id2 [... [idN]]]]</span></div><div><span style="color: rgb(255, 0, 0);">|    celery inspect registered [attr1 [attr2 [... [attrN]]]]</span></div><div><span style="color: rgb(255, 0, 0);">|    celery inspect report</span></div><div><span style="color: rgb(255, 0, 0);">|    celery inspect reserved</span></div><div><span style="color: rgb(255, 0, 0);">|    celery inspect revoked</span></div><div><span style="color: rgb(255, 0, 0);">|    celery inspect scheduled</span></div><div><span style="color: rgb(255, 0, 0);">|    celery inspect stats</span></div><div><br/></div><div><span style="color: rgb(255, 0, 0);">|    celery control --help</span></div><div><span style="color: rgb(255, 0, 0);">|    celery control add_consumer &lt;queue&gt; [exchange [type [routing_key]]]</span></div><div><span style="color: rgb(255, 0, 0);">|    celery control autoscale [max [min]]</span></div><div><span style="color: rgb(255, 0, 0);">|    celery control cancel_consumer &lt;queue&gt;</span></div><div><span style="color: rgb(255, 0, 0);">|    celery control disable_events</span></div><div><span style="color: rgb(255, 0, 0);">|    celery control election</span></div><div><span style="color: rgb(255, 0, 0);">|    celery control enable_events</span></div><div><span style="color: rgb(255, 0, 0);">|    celery control heartbeat</span></div><div><span style="color: rgb(255, 0, 0);">|    celery control pool_grow [N=1]</span></div><div><span style="color: rgb(255, 0, 0);">|    celery control pool_restart</span></div><div><span style="color: rgb(255, 0, 0);">|    celery control pool_shrink [N=1]</span></div><div><span style="color: rgb(255, 0, 0);">|    celery control rate_limit &lt;task_name&gt; &lt;rate_limit (e.g., 5/s | 5/m | 5/h)&gt;</span></div><div><span style="color: rgb(255, 0, 0);">|    celery control revoke [id1 [id2 [... [idN]]]]</span></div><div><span style="color: rgb(255, 0, 0);">|    celery control shutdown</span></div><div><span style="color: rgb(255, 0, 0);">|    celery control terminate &lt;signal&gt; [id1 [id2 [... [idN]]]]</span></div><div><span style="color: rgb(255, 0, 0);">|    celery control time_limit &lt;task_name&gt; &lt;soft_secs&gt; [hard_secs]</span></div></div><div><br/></div><div><br/></div><div><span style="font-size: 18pt; font-weight: bold;">四、Celery使用rabbitmq作为队列</span></div><div><br/></div><div>默认情况下，默认配置未针对吞吐量进行优化，它尝试在许多短任务和较少的长任务之间走中间路，吞吐量和公平调度之间的折中。</div><div>如果您使用RabbitMQ，那么您应该安装librabbitmq模块，这是一个在C中实现的AMQP客户端：</div><div style="box-sizing: border-box; padding: 8px; font-size: 12px; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);"><div><span style="background-color: rgb(251, 250, 248); font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">$ pip install librabbitmq</span></div></div><div><br/></div><div><br/></div><div><span style="font-size: 18pt; font-weight: bold;">五、Celery关闭重启，任务撤销</span></div><div><span style="font-size: 20px; background-color: rgb(255, 250, 165); font-weight: bold;-evernote-highlight:true;">关闭</span></div><div>    应使用TERM信号完成关机。</div><div>当关闭被启动时，worker在终止之前完成所有当前正在执行的任务，因此如果这些任务很重要，则在进行任何激烈的操作（如发送KILL信号）之前，您应该等待它完成。</div><div>如果worker在指定时间内不会关机，例如由于任务卡在无限循环中，您可以使用KILL信号强制终止工作人员，但请注意，当前正在执行的任务将丢失（除非任务具有 acks_late选项集）。</div><div>此外，由于进程不能覆盖KILL信号，因此worker将无法收到其子进程，因此请务必手动进行。 这个命令通常会做到这一点：</div><div style="box-sizing: border-box; padding: 8px; font-size: 12px; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);"><div><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;">$ ps auxww | grep 'celery worker' | awk '{print $2}' | xargs kill -9</span></div></div><div><span style="background-color: rgb(255, 250, 165); font-size: 19px; font-weight: bold;-evernote-highlight:true;">重启</span></div><div>除了关闭重开，还可以通过HUP信号重启：</div><div style="box-sizing: border-box; padding: 8px; font-size: 12px; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);"><div><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;">$ kill -HUP $pid</span></div></div><div>随后worker将以与原来相同的参数来替换自己的新实例。</div><div>HUP仅使用于后台守护进程的worker。</div><div><span style="background-color: rgb(255, 250, 165); font-size: 19px; font-weight: bold;-evernote-highlight:true;">撤销任务</span></div><div>支持的broker：amqp、redis</div><div>所有工作节点都保留内存中或永久磁盘上的已撤销任务ID的内存（请参阅 <a href="http://docs.jinkan.org/docs/celery/userguide/workers.html#worker-persistent-revokes" style="font-style: italic;">Persistent revokes</a>) 。</div><div>当worker收到撤销请求时，它将跳过执行任务，但除非设置了终止选项，否则它不会终止已执行的任务。</div><div>当任务被卡住时，终止选项是管理员的最后手段。 它不是为了终止任务，它用于终止正在执行任务的进程，并且该进程可能已经在信号发送时已经开始处理另一个任务，因此，在这个原因中，你绝对不能以编程方式调用它。</div><div>如果终止设置，则处理该任务的worker子进程将被终止。 发送的默认信号是TERM，但可以使用signal参数指定。 信号可以是Python标准库中信号模块中定义的任何信号的大写名称。</div><div>终止任务也会撤销它。</div><div>实例：</div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-size: 12px; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);"><div><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;">&gt;&gt;&gt; result.revoke()</span></div><div><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;">&gt;&gt;&gt; AsyncResult(id).revoke()</span></div><div><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;">&gt;&gt;&gt; app.control.revoke('d9078da5-9915-40a0-bfa1-392c7bde42ed')</span></div><div><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;">&gt;&gt;&gt; app.control.revoke('d9078da5-9915-40a0-bfa1-392c7bde42ed',</span></div><div><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;">...                   terminate=True)</span></div><div><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;">&gt;&gt;&gt; app.control.revoke('d9078da5-9915-40a0-bfa1-392c7bde42ed',</span></div><div><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;">...                   terminate=True, signal='SIGKILL')</span></div></div><div><span style="background-color: rgb(255, 250, 165); font-size: 19px; font-weight: bold;-evernote-highlight:true;">撤销多个任务</span></div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-size: 12px; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);"><div><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;">&gt;&gt;&gt; app.control.revoke([</span></div><div><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;">...    '7993b0aa-1f0b-4780-9af0-c47c0858b3f2',</span></div><div><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;">...    'f565793e-b041-4b2b-9ca4-dca22762a55d',</span></div><div><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;">...    'd9d35e03-2997-42d0-a13e-64a66b88a618',</span></div><div><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;">])</span></div></div><div>持续撤销</div><div><br/></div><div><span style="background-color: rgb(255, 250, 165); font-size: 19px; font-weight: bold;-evernote-highlight:true;">时间限制</span></div><div>一个任务可能会永远运行，如果你有很多任务等待一些事情永远不会发生，你将阻止worker无限期地处理新的任务。 防止这种情况发生的最佳方式是启用时间限制。</div><div>时间限制（-time-limit）是任务可以运行的最大秒数，在执行该进程的进程终止并被新进程替换之前。 您还可以启用软限时（-soft-time-limit），这引发了一个例外，任务可以在硬限制杀死之前捕获清理：</div><div style="box-sizing: border-box; padding: 8px; font-size: 12px; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);"><div><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;">from myapp import appfrom celery.exceptions import SoftTimeLimitExceeded</span></div><div><br/></div><div><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;">@app.taskdef mytask():</span></div><div><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;">    try:</span></div><div><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;">        do_work()</span></div><div><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;">    except SoftTimeLimitExceeded:</span></div><div><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;">        clean_up_in_a_hurry()</span></div></div><div>时间限制也可以使用CELERYD_TASK_TIME_LIMIT / CELERYD_TASK_SOFT_TIME_LIMIT设置进行设置。</div><div><span style="background-color: rgb(255, 250, 165); font-size: 19px; font-weight: bold;-evernote-highlight:true;">在运行时更改时间限制</span></div><div>有一个远程控制命令，可以更改任务的名称为time_limit的软和时间限制。</div><div style="box-sizing: border-box; padding: 8px; font-size: 12px; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);"><div><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;">&gt;&gt;&gt; app.control.time_limit('tasks.crawl_the_web',                          </span></div><div><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;">                               soft=60, hard=120, reply=True)</span></div><div><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;">[{'<a href="http://worker1.example.com/">worker1.example.com</a>': {'ok': 'time limits set successfully'}}]</span></div></div><div><br/></div><div><span style="font-size: 18pt; font-weight: bold;">六、队列相关</span></div><div>队列</div><div>worker实例可以从任意数量的队列中消费。 默认情况下，它将从CELERY_QUEUES设置中定义的所有队列（如果没有指定默认值为名称为celery的队列）消费。</div><div>您可以通过在-Q选项中提供逗号分隔的队列列表来指定启动时要消费的队列：</div><div style="box-sizing: border-box; padding: 8px; font-size: 12px; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);"><div><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;">$ celery worker -l info -Q foo,bar,baz</span></div></div><div>如果在CELERY_QUEUES中定义了队列名称，那么它将使用该配置，但是如果队列列表中没有定义，Celery会为您自动生成一个新队列（取决于CELERY_CREATE_MISSING_QUEUES选项）。</div><div>您还可以使用远程控制命令add_consumer和cancel_consumer告诉工作人员在运行时启动和停止使用队列。</div><div><br/></div><div>队列添加消费者</div><div style="box-sizing: border-box; padding: 8px; font-size: 12px; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);"><div><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;">$ celery control add_consumer foo</span></div><div><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;">-&gt; worker1.local: OK</span></div><div><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;">    started consuming from u'foo'</span></div></div><div>如果要指定特定的worker，可以使用--destination`参数：</div><div style="box-sizing: border-box; padding: 8px; font-size: 12px; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);"><div><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;">$ celery control add_consumer foo -d worker1.local</span></div></div><div>队列：取消消费者</div><div style="box-sizing: border-box; padding: 8px; font-size: 12px; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);"><div><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;">$ celery control cancel_consumer foo</span></div><div><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;">$ celery control cancel_consumer foo -d worker1.local</span></div></div><div>队列：活动队列列表</div><div style="box-sizing: border-box; padding: 8px; font-size: 12px; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);"><div><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;">$ celery inspect active_queues</span></div><div><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;">像所有其他远程控制命令一样，它还支持--destination参数，用于指定哪些工作人员应该回复请求：</span></div><div><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;">$ celery inspect active_queues -d worker1.local</span></div></div><div><br/></div><div>检查worker</div><div>celery.control.inspect允许您检查运行的工作人员。 它使用遥控器命令。</div><div>您也可以使用celery命令来检查工作人员，并且它支持与Celery.control接口相同的命令。</div><div>更改tasks.crawl_the_web任务的时间限制为一分钟的软时限，并且两分钟的困难时间限制的示例：</div><div style="box-sizing: border-box; padding: 8px; font-size: 12px; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);"><div><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"># Inspect all nodes.</span></div><div><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;">&gt;&gt;&gt; i = app.control.inspect()</span></div><div><br/></div><div><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"># Specify multiple nodes to inspect.</span></div><div><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;">&gt;&gt;&gt; i = app.control.inspect(['<a href="http://worker1.example.com/">worker1.example.com</a>',</span></div><div><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;">                            '<a href="http://worker2.example.com/">worker2.example.com</a>'])</span></div><div><br/></div><div><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"># Specify a single node to inspect.</span></div><div><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;">&gt;&gt;&gt; i = app.control.inspect('<a href="http://worker1.example.com/">worker1.example.com</a>')</span></div></div><div><br/></div><div>统计</div><div>远程控制命令检查stats（或stats（））将为您提供有关该worker的有用（或不太有用）统计信息的长列表：</div><div style="box-sizing: border-box; padding: 8px; font-size: 12px; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);"><div><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;">$ celery -A proj inspect stats</span></div></div><div><span style="background-color: rgb(255, 250, 165); font-size: 19px; font-weight: bold;-evernote-highlight:true;"><br/></span></div><div><span style="background-color: rgb(255, 250, 165); font-size: 19px; font-weight: bold;-evernote-highlight:true;">路由(Route)与队列(Queue)</span></div><div>如果不特殊指定，Celery将会创建名为celery的默认队列，用于消息传递。但在某些应用场景下，例如不同任务的耗时和优先级不同，不应让耗时低和优先级高的任务等待耗时较高优先级较低的任务执行，毕竟如上面提到的，worker进程的数量是有限的，过多的任务会造成任务等待，此时需要把不同的消息投递到不同的任务队列处理。</div><div><br/></div><div><span style="font-size: 18pt; font-weight: bold;">六、celery修饰器介绍</span></div><div><span style="background-color: rgb(255, 250, 165); font-size: 19px; font-weight: bold;-evernote-highlight:true;">关于task修饰器</span>，实际上是将函数修饰成一个celery task对象，可以加上参数来决定这些对象的属性。</div><div style="margin-top: 1em; margin-bottom: 1em;">首先，我们可以让被修饰的函数成为 task 对象的绑定方法，这样就相当于被修饰的函数 add 成了 task 的实例方法，可以调用 self 获取当前 task 实例的很多状态及属性。</div><div><br/></div><div>其次，我们也可以自己复写 task 类然后让这个自定义 task 修饰函数 add ，来做一些自定义操作。</div><div><br/></div><div><br/></div><div><br/></div><div><span style="font-size: 15px; font-weight: bold;">2.1 根据任务状态执行不同操作</span></div><div>任务执行后，根据任务状态执行不同操作需要我们复写 task 的 on_failure、on_success 等方法：</div><div style="box-sizing: border-box; padding: 8px; font-size: 12px; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);"><div><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"># tasks.py</span></div><div><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;">class MyTask(Task):</span></div><div><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;">    def on_success(self, retval, task_id, args, kwargs):</span></div><div><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;">        print 'task done: {0}'.format(retval)</span></div><div><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;">        return super(MyTask, self).on_success(retval, task_id, args, kwargs)</span></div><div><br/></div><div><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;">    def on_failure(self, exc, task_id, args, kwargs, einfo):</span></div><div><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;">        print 'task fail, reason: {0}'.format(exc)</span></div><div><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;">        return super(MyTask, self).on_failure(exc, task_id, args, kwargs, einfo)</span></div><div><br/></div><div><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;">@app.task(base=MyTask)</span></div><div><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;">def add(x, y):</span></div><div><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;">    return x + y</span></div></div><div>任务执行和失败都会先执行调用上面的MyTask函数。</div><div><span style="font-size: 15px; font-weight: bold;">2.2 绑定任务为实例方法</span></div><div style="box-sizing: border-box; padding: 8px; font-size: 12px; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);"><div><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"># tasks.py</span></div><div><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;">from celery.utils.log import get_task_logger</span></div><div><br/></div><div><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;">logger = get_task_logger(__name__)</span></div><div><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;">@app.task(bind=True)</span></div><div><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;">def add(self, x, y):</span></div><div><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;">    logger.info(self.request.__dict__)</span></div><div><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;">    return x + y</span></div></div><div>执行中的任务获取到了自己执行任务的各种信息，可以根据这些信息做很多其他操作，例如判断链式任务是否到结尾等等</div><div>关于 celery.task.request 对象的详细数据可以<a href="http://docs.celeryproject.org/en/latest/userguide/tasks.html#task-request-info">看这里</a></div><div style="font-size: 15px;"><span style="font-size: 15px; font-weight: bold;">2.3 任务状态回调</span></div><div style="margin-top: 1em; margin-bottom: 1em;">实际场景中得知任务状态是很常见的需求，对于 Celery 其内建任务状态有如下几种：</div><table><colgroup><col></col><col></col></colgroup><tbody><tr><td><div>参数</div></td><td><div>说明</div></td></tr><tr><td><div>PENDING</div></td><td><div>任务等待中</div></td></tr><tr><td><div>STARTED</div></td><td><div>任务已开始</div></td></tr><tr><td><div>SUCCESS</div></td><td><div>任务执行成功</div></td></tr><tr><td><div>FAILURE</div></td><td><div>任务执行失败</div></td></tr><tr><td><div>RETRY</div></td><td><div>任务将被重试</div></td></tr><tr><td><div>REVOKED</div></td><td><div>任务取消</div></td></tr></tbody></table><div><br/></div><div><br/></div><div>当我们有个耗时时间较长的任务进行时一般我们想得知它的实时进度，这里就需要我们自定义一个任务状态用来说明进度并手动更新状态，从而告诉回调当前任务的进度，具体实现：</div><div style="box-sizing: border-box; padding: 8px; font-size: 12px; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);"><div><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"># tasks.py</span></div><div><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;">from celery import Celery</span></div><div><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;">import time</span></div><div><br/></div><div><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;">@app.task(bind=True)</span></div><div><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;">def test_mes(self):</span></div><div><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;">    for i in xrange(1, 11):</span></div><div><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;">        time.sleep(0.1)</span></div><div><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;">        self.update_state(state=&quot;PROGRESS&quot;, meta={'p': i*10})</span></div><div><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;">    return 'finish'</span></div></div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-size: 12px; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);"><div><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"># trigger.py</span></div><div><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;">from task import add,test_mes</span></div><div><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;">import sys</span></div><div><br/></div><div><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;">def pm(body):</span></div><div><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;">    res = body.get('result')</span></div><div><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;">    if body.get('status') == 'PROGRESS':</span></div><div><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;">        sys.stdout.write('\r任务进度: {0}%'.format(res.get('p')))</span></div><div><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;">        sys.stdout.flush()</span></div><div><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;">    else:</span></div><div><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;">        print '\r'</span></div><div><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;">        print res</span></div><div><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;">r = test_mes.delay()</span></div><div><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;">print r.get(on_message=pm, propagate=False)</span></div></div><div><img src="celery大全_files/1b45e3260459d39c1db758c13cdd00b7.gif" type="image/gif" data-filename="1b45e3260459d39c1db758c13cdd00b7.gif" style="height: auto;"/></div><div style="font-size: 15px;"><span style="font-size: 15px; font-weight: bold;">2.4 定时/周期任务</span></div><div><br/></div><div>Celery 进行周期任务也很简单，只需要在配置中配置好周期任务，然后在运行一个周期任务触发器（ beat ）即可：</div><div>新建 Celery 配置文件 celery_config.py:</div><div style="box-sizing: border-box; padding: 8px; font-size: 12px; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);"><div><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"># celery_config.py</span></div><div><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;">from datetime import timedelta</span></div><div><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;">from celery.schedules import crontab</span></div><div><br/></div><div><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;">CELERYBEAT_SCHEDULE = {</span></div><div><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;">    'ptask': {</span></div><div><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;">        'task': 'tasks.period_task',</span></div><div><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;">        'schedule': timedelta(seconds=5),</span></div><div><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;">    },</span></div><div><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;">}</span></div><div><br/></div><div><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;">CELERY_RESULT_BACKEND = 'redis://localhost:6379/0'</span></div></div><div>配置中 schedule 就是间隔执行的时间，这里可以用 datetime.timedelta 或者 crontab 甚至太阳系经纬度坐标进行间隔时间配置，具体可以<a href="http://docs.celeryproject.org/en/latest/userguide/periodic-tasks.html#crontab-schedules">参考这里</a></div><div>如果定时任务涉及到 datetime 需要在配置中加入时区信息，否则默认是以 utc 为准。例如中国可以加上：</div><div style="box-sizing: border-box; padding: 8px; font-size: 12px; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);"><div><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;">CELERY_TIMEZONE = 'Asia/Shanghai'</span></div></div><div>然后在 tasks.py 中增加要被周期执行的任务：</div><div style="box-sizing: border-box; padding: 8px; font-size: 12px; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);"><div><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"># tasks.py</span></div><div><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;">app = Celery('tasks', backend='redis://localhost:6379/0', broker='redis://localhost:6379/0')</span></div><div><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;">app.config_from_object('celery_config')</span></div><div><br/></div><div><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;">@app.task(bind=True)</span></div><div><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;">def period_task(self):</span></div><div><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;">    print 'period task done: {0}'.format(self.request.id)</span></div></div><div>然后重新运行 worker，接着再运行 beat：</div><div style="box-sizing: border-box; padding: 8px; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);"><div><span style="font-size: 12px; background-color: rgb(251, 250, 248); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; color: rgb(51, 51, 51);">celery -A task beat</span></div></div><div style="font-size: 15px;"><span style="font-size: 15px; font-weight: bold;">2.5 链式任务</span></div><div>有些任务可能需由几个子任务组成，此时调用各个子任务的方式就变的很重要，尽量不要以同步阻塞的方式调用子任务，而是用异步回调的方式进行链式任务的调用：</div><div><span style="font-size: 18pt; font-weight: bold;">七、celery分布式消费者</span></div><div>Celery也是一个分布式的消息系统，那么如何利用分布式的方法执行任务呢？</div><div style="margin-top: 1em; margin-bottom: 1em;">Celery的分布式实际包含两个层次：</div><ol><li>Distribute work on a given machine across all CPUs</li><li>Distribute work to many machines</li></ol><div><br/></div><div>先说第一点，默认情况下，Celery在一台机器上启动worker，worker的进程数量和机器的CPU个数一致。但也可以通过concurrency参数控制启动worker的进程数量：</div><div style="box-sizing: border-box; padding: 8px; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);"><div><span style="font-size: 12px; background-color: rgb(251, 250, 248); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; color: rgb(51, 51, 51);">同时启动5个worker进程</span></div><div><span style="font-size: 12px; background-color: rgb(251, 250, 248); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; color: rgb(51, 51, 51);">celery -A tasks worker --loglevel=INFO --concurrency=5</span></div></div><div>比如你的机器只有一个CPU，但仍然可以通过上述方法启动5个worker进程，在某些IO密集型的任务中，可以考虑启动worker的数量多于CPU数量，在CPU密集型的任务中，这样的操作可能没有什么好处。</div><div style="margin-top: 1em; margin-bottom: 1em;">再说第二点，因为Celery只指定了worker的broker，所以只需要在不同机器上启动worker，它们都会从相同的broker中获取任务并处理。</div><div style="margin-top: 1em; margin-bottom: 1em;">在考虑不同机器上的操作时，涉及远程控制的概念。</div><ol><li>celery inspect</li></ol><div><br/></div><div>观察所有运行worker的信息，例如观察当前处于活跃状态的worker和task：</div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-size: 12px; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);"><div><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;">celery -A tasks inspect active</span></div></div><ol><li>celery control</li></ol><div><br/></div><div>控制worker的行为，例如向worker中增加对某队列的消费：</div><div style="box-sizing: border-box; padding: 8px; font-size: 12px; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);"><div><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;">celery control -d <a href="http://w1.e.com/">w1.e.com</a> add_consumer queue_name</span></div></div><ol><li>celery status</li></ol><div><br/></div><div>观察当前worker状态</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;-en-codeblock:true;"><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">celery -A tasks status</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"># celery@iZ25d0yvrwwZ: OK</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">#</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"># 1 node online.</span></div></div><div><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;"><br/></span></div><div><span style="font-size: 18pt; font-weight: bold; font-family: Monaco; color: rgb(51, 51, 51);">八、celery实践</span></div><div>提示与最佳实践</div><div>如果不想要结果，一定要设置 ignore_result选项, 甚至可以使用CELERY_IGNORE_RESULT设置全局禁用结果。</div><div style="box-sizing: border-box; padding: 8px; font-size: 12px; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);"><div><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;">@app.task(ignore_result=True)</span></div></div><div>如果不使用速率限制，请禁用它们</div><div><br/></div><div>如果您没有使用任何任务，建议完全禁用速率限制。 这是因为速率限制子系统引入了相当多的复杂性。</div><div><br/></div><div>将CELERY_DISABLE_RATE_LIMITS设置设置为全局禁用速率限制：</div><div style="box-sizing: border-box; padding: 8px; font-size: 12px; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);"><div><span style="background-color: rgb(251, 250, 248); color: rgb(51, 51, 51); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px;">CELERY_DISABLE_RATE_LIMITS = True</span></div></div><div>更多的优化提示：<a href="http://docs.jinkan.org/docs/celery/userguide/optimizing.html#guide-optimizing">http://docs.jinkan.org/docs/celery/userguide/optimizing.html#guide-optimizing</a></div><div><br/></div><div>避免启动同步子任务</div><div><br/></div><div>任务等待另一个任务的结果是真的没有效率，如果工作池耗尽，甚至可能会导致死锁。</div><div><br/></div><div>使您的设计异步，例如使用回调。    对于需要任务链的情况，参考：<a href="http://docs.jinkan.org/docs/celery/userguide/tasks.html#task-best-practices">http://docs.jinkan.org/docs/celery/userguide/tasks.html#task-best-practices</a></div><div><span style="font-size: 18pt; font-weight: bold; font-family: Monaco; color: rgb(51, 51, 51);"><br/></span></div><div><br/></div></div></span>
</div></body></html> 